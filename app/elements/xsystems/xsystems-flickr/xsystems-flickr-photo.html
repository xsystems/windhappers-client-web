<dom-module id="xsystems-flickr-photo">
  <template>
    <style>

    </style>

    <iron-ajax  id="photoInfoAjax"
                url="https://api.flickr.com/services/rest/"
                debounce-duration="[[debounceDuration]]"
                last-response="{{_responseInfo}}"></iron-ajax>

    <iron-ajax  id="photoSizesAjax"
                url="https://api.flickr.com/services/rest/"
                debounce-duration="[[debounceDuration]]"
                last-response="{{_responseSizes}}"></iron-ajax>

  </template>
  <script>
    (function() {
      'use strict';
      Polymer({
        is: 'xsystems-flickr-photo',

        properties: {
          key: String,
          photoId: String,
          secret: String,
          size: {
            type: String,
            value: 'Original'
          },
          debounceDuration: Number,
          
          title: {
            type: String,
            readOnly: true,
            notify: true
          },
          description: {
            type: String,
            readOnly: true,
            notify: true
          },
          url: {
            type: String,
            readOnly: true,
            notify: true
          }
        },

        observers: [
          '_computeRequestParams(key, photoId, size)',
          '_processResponseInfo(_responseInfo)',
          '_processResponseSizes(_responseSizes)'
        ],

        _computeRequestParams: function(key, photoId, size) {
          var requestParamsInfo = {};
          requestParamsInfo.format = 'json';
          requestParamsInfo.nojsoncallback = 1;
          requestParamsInfo.method = 'flickr.photos.getInfo';
          requestParamsInfo.api_key = key;
          requestParamsInfo.photo_id = photoId;

          if (this.secret != null) {
            requestParamsInfo.secret = this.secret;
          }

          this.$.photoInfoAjax.params = requestParamsInfo;
          this.$.photoInfoAjax.generateRequest();

          var requestParamsSizes = {};
          requestParamsSizes.format = 'json';
          requestParamsSizes.nojsoncallback = 1;
          requestParamsSizes.method = 'flickr.photos.getSizes';
          requestParamsSizes.api_key = key;
          requestParamsSizes.photo_id = photoId;

          this.$.photoSizesAjax.params = requestParamsSizes;
          this.$.photoSizesAjax.generateRequest();
        },

        _processResponseInfo: function(responseInfo) {
          if (responseInfo.stat != "ok") {
            return;
          }

          var photoInfo = responseInfo.photo;

          this._setTitle(photoInfo.title._content);
          this._setDescription(photoInfo.description._content);
        },

        _processResponseSizes: function(responseSizes) {
          if (responseSizes.stat != "ok") {
            return;
          }

          var photoSizes = responseSizes.sizes.size;

          for (var i = 0; i < photoSizes.length; i++) {
            var photoSize = photoSizes[i];
            if (photoSize.label == this.size) {
              this._setUrl(photoSize.source);
            }
          }
        }
      });
    })();
  </script>
</dom-module>
