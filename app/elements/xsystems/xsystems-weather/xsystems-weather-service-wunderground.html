<dom-module id="xsystems-weather-service-wunderground">
  <template>
    <style>

    </style>

    <iron-ajax  id="wundergroundAjax"
                url="http://api.wunderground.com/api/[[key]]/geolookup/forecast/q/[[query]].json"
                params="[[params]]"
                last-response="{{response}}"></iron-ajax>

  </template>
  <script>
    (function() {
      'use strict';
      Polymer({
        is: 'xsystems-weather-service-wunderground',

        properties: {
          key: String,
          query: {
            type: String,
            value: "Netherlands/The_Hague"
          },
          params: Object,
          interval: {
            type: Number,
            value: 600
          },
          fahrenheit: Boolean,
          data: {
            type: Object,
            readOnly: true,
            notify: true
          }
        },

        observers: [
          '_processResponse(response)'
        ],

        attached: function() {
          this.$.wundergroundAjax.generateRequest();
          window.setInterval(function() {
            this.$.wundergroundAjax.generateRequest();
          }.bind(this), this.interval * 1000);
        },

        _processResponse: function(response) {
          var locationResponse = response.location;
          var location = {};
          location.country = locationResponse.country;
          location.city = locationResponse.city;

          var forecastdays = response.forecast.simpleforecast.forecastday;
          var forecast = [];
          for (var i = 0; i < forecastdays.length; i++) {
            var forecastday = forecastdays[i];

            var day = {};
            day.weekday = forecastday.date.weekday;
            day.weekdayShort = forecastday.date.weekday_short;
            day.iconUrl = forecastday.icon_url;
            day.conditions = forecastday.conditions;
            day.temperature = {};
            day.temperature.high = this.fahrenheit ? forecastday.high.fahrenheit : forecastday.high.celsius;
            day.temperature.low = this.fahrenheit ? forecastday.low.fahrenheit : forecastday.low.celsius;

            forecast.push(day);
          }

          var data = {};
          data.location = location;
          data.forecast = forecast;

          this._setData(data);
        }
      });
    })();
  </script>
</dom-module>
