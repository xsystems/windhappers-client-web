<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/google-sheets/google-sheets.html">
<link rel="import" href="../bower_components/google-youtube/google-youtube.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/neon-animation/neon-animated-pages.html">
<link rel="import" href="../bower_components/neon-animation/neon-animatable.html">
<link rel="import" href="../bower_components/paper-card/paper-card.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/xsystems-youtube/xsystems-youtube.html">
<link rel="import" href="windhappers-overlay.html">
<link rel="import" href="windhappers-volunteer.html">

<dom-module id="windhappers-page-videos">
  <template>
    <style>
      :host {
        @apply(--layout-vertical);
        @apply(--layout-flex);
        padding-left: 1%;
        padding-right: 1%;
      }

      #videoPlayerCard {
        padding: 1%;
      }

      :host:not([narrow]) #videoPlayerCard {
        width: 854px;
        height: 480px;
      }

      :host[narrow] #videoPlayerCard {
        width: 100vw;
        height: 55vw;
      }

      #videoPlayer {
        width: 100%;
        height: 100%;
      }

      #volunteerContainer {
        @apply(--layout-horizontal);
        @apply(--layout-justified);
        @apply(--layout-wrap);
        display: block;
        width: 100%;
      }

      windhappers-volunteer {
        margin-bottom: 1%;
      }

      @-moz-document url-prefix() {
        windhappers-volunteer {
          margin-bottom: 0.8em;
        }
      }

      :host[narrow] windhappers-volunteer {
        width: 100%;
      }

      :host:not([narrow]) windhappers-volunteer {
        width: 32.66%;
      }

      #filler {
        @apply(--layout-flex);
      }
    </style>

    <app-route  route="{{route}}"
                pattern="/:videoId"
                active="{{videoActive}}"
                data="{{videoData}}"
                tail="{{videoTail}}"></app-route>

    <paper-input id="queryInput" label="Welke video zoek je?" value="{{query}}">
      <paper-icon-button suffix icon="search"></paper-icon-button>
    </paper-input>

    <xsystems-youtube-videos  narrow$="[[narrow]]"
                              key="AIzaSyDTj9__sWn_MKroJ6vlad1pCCidRBi6a5g"
                              query="[[query]]"
                              channel="UCWBof-CO7GALxQfbO6z9c8A"
                              selected="{{video}}"
                              scroll-target="[[scrollTarget]]">
    </xsystems-youtube-videos>

    <div id="filler"></div>

    <google-sheets  id="sheetVolunteers"
                key="17WpTzAng1WyamrsJR40S2yECPQJGENhPaM4S0zeSdEY"
                tab-id="1"
                published
                rows="{{rows}}"></google-sheets>

    <div id="volunteerContainer">
      <template is="dom-repeat" items="[[rows]]" as="row" filter="_isRelatedVolunteer">
        <windhappers-volunteer name="{{row.gsx$name.$t}}"
                               role="{{row.gsx$role.$t}}"
                               email="{{row.gsx$email.$t}}"
                               email-personal="{{row.gsx$emailpersonal.$t}}"
                               phone="{{row.gsx$phone.$t}}">
        </windhappers-volunteer>
      </template>

      <div id="fillerVolunteer"></div>
    </div>

    <windhappers-overlay  id="videoOverlay"
                          on-iron-overlay-closed="_deselectVideo">
      <paper-card id="videoPlayerCard"
                  elevation="5">
        <google-youtube id="videoPlayer"
                        video-id="[[videoData.videoId]]"
                        width="100%"
                        height="100%"
                        rel="0"
                        showinfo="0"
                        iv_load_policy="3"
                        modestbranding="1">
        </google-youtube>
      </paper-card>
    </windhappers-overlay>

  </template>
  <script>
    (function() {
      'use strict';
      Polymer({
        is: 'windhappers-page-videos',

        properties: {
          route: Object,
          narrow: Boolean,
          scrollTarget: HTMLElement
        },

        observers: [
          '_handleVideoId(videoData.videoId)',
          '_handleSelectedVideo(video)',
          '_handleActive(videoActive)',
          '_handleRows(rows)',
        ],

        created: function() {
          window.performance && performance.mark && performance.mark('windhappers-page-videos: created');
          this.removeAttribute('unresolved');
        },

        _handleVideoId: function(videoId) {
          if (videoId != null) {
            this.$.videoOverlay.open();
          } else {
            this.$.videoOverlay.close();
          }
        },

        _handleSelectedVideo: function(video) {
            this.set('route.path', video ? video.id.videoId : '');
        },

        _deselectVideo: function(event) {
          this.$.videoPlayer.pause();
          this.video = null;
        },

        _handleActive: function(videoActive) {
          if (!videoActive) {
            this._handleVideoId(null);
          }
        },

        _isRelatedVolunteer: function(row) {
          return ['Redacteur video\'s'].indexOf(row.gsx$role.$t) > -1;
        },

        _handleRows: function(rows) {
          var numberOfRelatedVolunteers = 0;

          for (var i = 0; i < rows.length; i++) {
            if (this._isRelatedVolunteer(rows[i])) {
              numberOfRelatedVolunteers++;
            }
          }

          var numberOfItemsToFillRow = 3 - numberOfRelatedVolunteers % 3;
          if (numberOfItemsToFillRow < 3) {
            this.$.fillerVolunteer.style.width = numberOfItemsToFillRow * 32.66 + '%';
            this.$.fillerVolunteer.style.display = '';
          } else {
            this.$.fillerVolunteer.style.display = 'none';
          }
        },
      });
    })();
  </script>
</dom-module>
