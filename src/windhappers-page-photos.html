<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/iron-image/iron-image.html">
<link rel="import" href="../bower_components/neon-animation/neon-animated-pages.html">
<link rel="import" href="../bower_components/neon-animation/neon-animatable.html">
<link rel="import" href="../bower_components/paper-card/paper-card.html">
<link rel="import" href="../bower_components/xsystems-flickr/xsystems-flickr.html">
<link rel="import" href="windhappers-overlay.html">

<dom-module id="windhappers-page-photos">
  <template>
    <style>
      :host {
        @apply(--layout-vertical);
        @apply(--layout-flex);
      }

      neon-animated-pages, neon-animatable {
        @apply(--layout-vertical);
        @apply(--layout-flex);
      }

      #photoCard {
        padding: 1%;
      }

      :host:not([narrow]) #photoCard {
        width: 854px;
        height: 480px;
      }

      :host[narrow] #photoCard {
        width: 100vw;
        height: 55vw;
      }

      #photoCard > a {
        width: 100%;
        height: 100%;
      }

      #photo {
        width: 100%;
        height: 100%;
      }

      iron-image {
        background-color: var(--accent-color);
      }
    </style>

    <app-route  route="{{route}}"
                pattern="/:photosetId"
                active="{{photosetActive}}"
                data="{{photosetData}}"
                tail="{{photosetTail}}"></app-route>

    <app-route  route="{{photosetTail}}"
                pattern="/:photoId"
                active="{{photoActive}}"
                data="{{photoData}}"
                tail="{{photoTail}}"></app-route>

    <neon-animated-pages  selected="[[selectedPage]]"
                          attr-for-selected="data-page"
                          fallback-selection="photosets">
      <neon-animatable data-page="photosets">

        <xsystems-flickr-photosets-view narrow$="[[narrow]]"
                                        key="757b4474c3d5653a8958a33d9cf647a2"
                                        user-id="143394479@N04"
                                        selected="{{photoset}}">
        </xsystems-flickr-photosets-view>

      </neon-animatable>
      <neon-animatable data-page="photos">

        <xsystems-flickr-photoset-view  narrow$="[[narrow]]"
                                        key="757b4474c3d5653a8958a33d9cf647a2"
                                        user-id="143394479@N04"
                                        photoset-id="[[photosetData.photosetId]]"
                                        selected="{{photo}}">
        </xsystems-flickr-photoset-view>

        <xsystems-flickr-photo  key="757b4474c3d5653a8958a33d9cf647a2"
                                photo-id="[[photoData.photoId]]"
                                url="{{url}}">
        </xsystems-flickr-photo>

        <windhappers-overlay id="photoOverlay"
                          on-iron-overlay-closed="_deselectPhoto">
          <paper-card id="photoCard"
                      elevation="5">
            <a href="[[url]]" download>
              <iron-image id="photo"
                          preload
                          fade
                          sizing="cover"
                          src="[[url]]">
              </iron-image>
            </a>
          </paper-card>
        </windhappers-overlay>

      </neon-animatable>
    </neon-animated-pages>

  </template>
  <script>
    (function() {
      'use strict';
      Polymer({
        is: 'windhappers-page-photos',

        properties: {
          route: Object,
          narrow: Boolean
        },

        observers: [
          '_handlePhotoset(photoset)',
          '_handlePhotosetId(photosetData.photosetId)',
          '_handlePhoto(photo)',
          '_handlePhotoId(photoData.photoId)',
          '_handleActive(photosetActive, photoActive)'
        ],

        _handlePhotoset: function(photoset){
          this.set('route.path', photoset ? photoset.id : null);
        },

        _handlePhotosetId: function(photosetId) {
          if (photosetId) {
            this.selectedPage = "photos";
          } else {
            this.selectedPage = "photosets";
            this.photoset = null;
          }
        },

        _handlePhoto: function(photo) {
          this.set('photosetTail.path', photo ? photo.id : null);
        },

        _handlePhotoId: function(photoId) {
          if (photoId) {
            this.$.photoOverlay.close();
            this.$.photoOverlay.open();
          } else {
            this.$.photoOverlay.close();
          }
        },

        _deselectPhoto: function(event) {
          this.photo = null;
        },

        _handleActive: function(photosetActive, photoActive) {
          if (!photosetActive) {
            this._handlePhotosetId(null);
          }

          if (!photoActive) {
            this._handlePhotoId(null);
          }
        }
      });
    })();
  </script>
</dom-module>
