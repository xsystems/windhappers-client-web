<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/google-sheets/google-sheets.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/iron-image/iron-image.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/paper-card/paper-card.html">
<link rel="import" href="../bower_components/xsystems-flickr/xsystems-flickr.html">
<link rel="import" href="windhappers-overlay.html">
<link rel="import" href="windhappers-volunteer.html">

<dom-module id="windhappers-page-photos">
  <template>
    <style>
      :host {
        @apply(--layout-vertical);
        @apply(--layout-flex);
        padding-left: 1%;
        padding-right: 1%;
      }

      #photoCard {
        padding: 1%;
      }

      :host:not([narrow]) #photoCard {
        width: 854px;
        height: 480px;
      }

      :host[narrow] #photoCard {
        width: 100vw;
        height: 55vw;
      }

      #photoCard > a {
        width: 100%;
        height: 100%;
      }

      #photo {
        width: 100%;
        height: 100%;
      }

      iron-image {
        background-color: var(--accent-color);
      }

      #volunteerContainer {
        @apply(--layout-horizontal);
        @apply(--layout-justified);
        @apply(--layout-wrap);
        display: block;
        width: 100%;
      }

      windhappers-volunteer {
        margin-bottom: 1%;
      }

      @-moz-document url-prefix() {
        windhappers-volunteer {
          margin-bottom: 0.8em;
        }
      }

      :host[narrow] windhappers-volunteer {
        width: 100%;
      }

      :host:not([narrow]) windhappers-volunteer {
        width: 32.66%;
      }

      #filler {
        @apply(--layout-flex);
      }
    </style>

    <app-route  route="{{route}}"
                pattern="/:photosetId"
                active="{{photosetActive}}"
                data="{{photosetData}}"
                tail="{{photosetTail}}"></app-route>

    <app-route  route="{{photosetTail}}"
                pattern="/:photoId"
                active="{{photoActive}}"
                data="{{photoData}}"
                tail="{{photoTail}}"></app-route>

    <xsystems-flickr-photo  key="757b4474c3d5653a8958a33d9cf647a2"
                            photo-id="[[photoData.photoId]]"
                            url="{{url}}">
    </xsystems-flickr-photo>

    <windhappers-overlay id="photoOverlay"
                      on-iron-overlay-closed="_deselectPhoto">
      <paper-card id="photoCard"
                  elevation="5">
        <a href="[[url]]" download>
          <iron-image id="photo"
                      preload
                      fade
                      sizing="cover"
                      src="[[url]]">
          </iron-image>
        </a>
      </paper-card>
    </windhappers-overlay>

    <iron-pages selected="[[selectedPage]]"
                attr-for-selected="data-page"
                fallback-selection="photosets">
      <xsystems-flickr-photosets-view data-page="photosets"
                                      narrow$="[[narrow]]"
                                      key="757b4474c3d5653a8958a33d9cf647a2"
                                      user-id="143394479@N04"
                                      selected="{{photoset}}">
      </xsystems-flickr-photosets-view>
      <xsystems-flickr-photoset-view  data-page="photos"
                                      narrow$="[[narrow]]"
                                      key="757b4474c3d5653a8958a33d9cf647a2"
                                      user-id="143394479@N04"
                                      photoset-id="[[photosetData.photosetId]]"
                                      selected="{{photo}}"
                                      scroll-target="[[scrollTarget]]">
      </xsystems-flickr-photoset-view>
    </iron-pages>

    <div id="filler"></div>

    <google-sheets  id="sheetVolunteers"
                key="17WpTzAng1WyamrsJR40S2yECPQJGENhPaM4S0zeSdEY"
                tab-id="1"
                published
                rows="{{rows}}"></google-sheets>

    <div id="volunteerContainer">
      <template is="dom-repeat" items="[[rows]]" as="row" filter="_isRelatedVolunteer">
        <windhappers-volunteer name="{{row.gsx$name.$t}}"
                               function="{{row.gsx$function.$t}}"
                               email="{{row.gsx$email.$t}}"
                               email-personal="{{row.gsx$emailpersonal.$t}}"
                               phone="{{row.gsx$phone.$t}}">
        </windhappers-volunteer>
      </template>

      <div id="fillerVolunteer"></div>
    </div>

  </template>
  <script>
    (function() {
      'use strict';
      Polymer({
        is: 'windhappers-page-photos',

        properties: {
          route: Object,
          narrow: Boolean,
          scrollTarget: HTMLElement
        },

        observers: [
          '_handlePhotoset(photoset)',
          '_handlePhotosetId(photosetData.photosetId)',
          '_handlePhoto(photo)',
          '_handlePhotoId(photoData.photoId)',
          '_handleActive(photosetActive, photoActive)',
          '_handleRows(rows)',
        ],

        created: function() {
          window.performance && performance.mark && performance.mark('windhappers-page-photos: created');
          this.removeAttribute('unresolved');
        },

        _handlePhotoset: function(photoset){
          this.set('route.path', photoset ? photoset.id : null);
        },

        _handlePhotosetId: function(photosetId) {
          if (photosetId) {
            this.selectedPage = "photos";
          } else {
            this.selectedPage = "photosets";
            this.photoset = null;
          }
        },

        _handlePhoto: function(photo) {
          this.set('photosetTail.path', photo ? photo.id : null);
        },

        _handlePhotoId: function(photoId) {
          if (photoId) {
            this.$.photoOverlay.close();
            this.$.photoOverlay.open();
          } else {
            this.$.photoOverlay.close();
          }
        },

        _deselectPhoto: function(event) {
          this.photo = null;
        },

        _handleActive: function(photosetActive, photoActive) {
          if (!photosetActive) {
            this._handlePhotosetId(null);
          }

          if (!photoActive) {
            this._handlePhotoId(null);
          }
        },

        _isRelatedVolunteer: function(row) {
          return ['Redacteur foto\'s'].indexOf(row.gsx$function.$t) > -1;
        },

        _handleRows: function(rows) {
          var numberOfRelatedVolunteers = 0;

          for (var i = 0; i < rows.length; i++) {
            if (this._isRelatedVolunteer(rows[i])) {
              numberOfRelatedVolunteers++;
            }
          }

          var numberOfItemsToFillRow = 3 - numberOfRelatedVolunteers % 3;
          if (numberOfItemsToFillRow < 3) {
            this.$.fillerVolunteer.style.width = numberOfItemsToFillRow * 32.66 + '%';
            this.$.fillerVolunteer.style.display = '';
          } else {
            this.$.fillerVolunteer.style.display = 'none';
          }
        },
      });
    })();
  </script>
</dom-module>
